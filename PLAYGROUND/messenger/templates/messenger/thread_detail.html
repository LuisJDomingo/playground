{% extends 'core/base.html' %}
{% load static %}

{% block title %}Hilo{% endblock %}

{% block content %}
<style>
  .avatar  { width:50px; height:50px; float:left; margin-right:10px; }
  .thread  { max-height:300px; overflow-y:auto; padding:0 0.5em; }

  .mine    { padding:0 0.5em 0.25em; background-color:rgba(230,242,245,.5); width:92%; margin-left:8%; text-align:right; }
  .other   { padding:0 0.5em 0.25em; background-color:#f2f3f5; width:92%; text-align:left; }

  .fade-in-left {
    animation: slideFadeLeft 0.4s ease-out forwards;
    opacity: 0;
    transform: translateX(-40px);
  }

  .fade-in-right {
    animation: slideFadeRight 0.4s ease-out forwards;
    opacity: 0;
    transform: translateX(40px);
  }

  @keyframes slideFadeLeft {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes slideFadeRight {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>

<main role="main">
  <div class="container">
    <div class="row mt-3">
      <div class="col-md-9 mx-auto mb-5">
        <div class="row">
          <div class="col-md-4">
            {% for thread in request.user.threads.all %}
              {% if thread.messages.all|length > 0 %}
                <div class="mb-3">
                  {% for user in thread.users.all %}
                    {% if user != request.user %}
                      {% if user.profile.avatar %}
                        <img src="{{user.profile.avatar.url}}" class="avatar">
                      {% else %}
                        <img src="{% static 'registration/img/no-avatar.jpg' %}" class="avatar">
                      {% endif %}
                      <div>
                        <a href="{% url 'messenger:detail' thread.pk %}">{{user}}</a><br>
                        <small><i>Hace {{thread.messages.last.created|timesince}}</i></small>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>

          <div class="col-md-8">
            {% for user in thread.users.all %}
              {% if user != request.user %}
                <h4 class="mb-4">Mensajes con <a href="{% url 'profiles:profile_detail' user %}">{{user}}</a></h4>
              {% endif %}
            {% endfor %}

            <div class="thread" id="thread">
              {% for message in object.messages.all %}
                <div {% if request.user == message.user %}class="mine mb-3"{% else %}class="other mb-3"{% endif %}>
                  <small><i>Hace {{message.created|timesince}}</i></small><br>
                  {{message.content}}
                </div>
              {% endfor %}
            </div>

            <textarea id="content" class="form-control mt-2" rows="2" placeholder="Escribe un mensaje..."></textarea>
            <button id="send" class="btn btn-primary btn-sm btn-block mt-3" disabled>Enviar</button>

            <script>
              function ScrollBotomInThread() {
                const thread = document.getElementById('thread');
                thread.scrollTop = thread.scrollHeight;
              }
              ScrollBotomInThread();

              const currentUser = "{{ request.user.username }}";
              const threadId = "{{ thread.pk }}";
              const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
              const chatSocket = new WebSocket(
                ws_scheme + '://' + window.location.host + '/ws/messenger/' + threadId + '/'
              );

              function createAnimatedMessage(content, user, isMine) {
                const msg = document.createElement('div');
                msg.classList.add(isMine ? 'mine' : 'other', 'mb-3');

                msg.innerHTML = `
                  <small><i>${isMine ? 'TÃº' : user}</i></small><br>
                  ${content}
                `;

                const thread = document.getElementById('thread');
                thread.appendChild(msg);

                requestAnimationFrame(() => {
                  msg.classList.add(isMine ? 'fade-in-right' : 'fade-in-left');
                });

                ScrollBotomInThread();
              }

              chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log("WebSocket received:", data);
                const isMine = data.user === currentUser;

                createAnimatedMessage(data.message, data.user, isMine);
                
              };
              chatSocket.onclose = function(e) {
                console.error('WebSocket cerrado inesperadamente');
              };

              document.getElementById('send').onclick = function() {
                const input = document.getElementById('content');
                const message = input.value.trim();

                if (message.length > 0) {
                  chatSocket.send(JSON.stringify({ 'message': message }));
                  input.value = '';
                  document.getElementById('send').disabled = true;
                }
              };

              document.getElementById('content').addEventListener('input', function() {
                document.getElementById('send').disabled = this.value.trim().length === 0;
              });
            </script>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}
